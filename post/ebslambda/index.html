<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.27.1" />
  <meta name="author" content="Bapi Loya">
  <meta name="description" content="Devops Engineer">

  
  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  


  

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700%7cRoboto:400,400italic,700%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-108367053-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  <link rel="alternate" href="" type="application/rss+xml" title="Bapi Loya">
  <link rel="feed" href="" type="application/rss+xml" title="Bapi Loya">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="https://bapi24.github.io/post/ebslambda/">

  

  <title>Working with AWS Lambda | Bapi Loya</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Bapi Loya</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
          </a>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  
<div class="article-header">
  <img src="/img/headers/EbsLambda.png" class="article-banner" itemprop="image">
  
</div>



  <div class="article-container">
    <h1 itemprop="name">Working with AWS Lambda</h1>
    

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2018-02-14 00:00:00 -0600 CST" itemprop="datePublished">
      Feb 14, 2018
    </time>
  </span>

  
  <span class="article-reading-time">
    3 min read
  </span>
  

  

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="/tags/tags">tags</a
    >, 
    
    <a href="/tags/aws">aws</a
    >, 
    
    <a href="/tags/boto3">boto3</a
    >, 
    
    <a href="/tags/ebs">EBS</a
    >, 
    
    <a href="/tags/serverless">serverless</a
    >, 
    
    <a href="/tags/lambda">lambda</a
    >, 
    
    <a href="/tags/ec2">ec2</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Working%20with%20AWS%20Lambda&amp;url=https%3a%2f%2fbapi24.github.io%2fpost%2febslambda%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fbapi24.github.io%2fpost%2febslambda%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fbapi24.github.io%2fpost%2febslambda%2f&amp;title=Working%20with%20AWS%20Lambda"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fbapi24.github.io%2fpost%2febslambda%2f&amp;title=Working%20with%20AWS%20Lambda"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Working%20with%20AWS%20Lambda&amp;body=https%3a%2f%2fbapi24.github.io%2fpost%2febslambda%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

    <div class="article-style" itemprop="articleBody">
      

<p><a href="https://aws.amazon.com/lambda/" target="_blank">AWS Lambda</a> automatically runs your code without requiring you to manage any servers. With Lambda, you can run code for virtually any type of application or backend service - all with zero administration. Just upload your code and Lambda takes care of everything required to run and scale your code with high availability. You can set up your code to automatically trigger from other AWS services or call it directly from any web or mobile app. You pay only for the compute time you consume - there is no charge when your code is not running.</p>

<p>In my <a href="https://bapi24.github.io/post/aws-tags/" target="_blank">previous</a> post, we have worked tagging the <a href="https://aws.amazon.com/ebs/" target="_blank">EBS</a> volumes with the help of a python script. Now lets work on deploying that function through <a href="https://aws.amazon.com/lambda/" target="_blank">AWS Lambda</a> which gets triggered every 60 mins(customizable).</p>

<p>Before jumping into the code, lets see what are we trying to achieve here. We want to automate the task of appending our <a href="https://aws.amazon.com/ec2/" target="_blank">EC2</a> tags on the corresponding EBS volumes on regular intervals of time, to help us keep the EBS volumes organized.</p>

<p><img src="/img/lambda/lambda_a.png" alt="Working with Lambda" /></p>

<h3 id="steps"><strong>STEPS</strong>:</h3>

<ul>
<li>We need to give access to Lambda function(L) to talk to EC2 instances(E) and Cloudwatch Log groups(CL).</li>
</ul>

<pre><code class="language-yaml">AWSTemplateFormatVersion: '2010-09-09'

Description: Create IAM roles and policies to tag EBS volumes based on EC2 tags

Resources:
  EbsLambdaServiceRole:
    Type: &quot;AWS::IAM::Role&quot;
    Properties:
      AssumeRolePolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          -
            Effect: &quot;Allow&quot;
            Principal:
              Service:
                - &quot;lambda.amazonaws.com&quot;
            Action:
              - &quot;sts:AssumeRole&quot;
      Path: &quot;/&quot;
      ManagedPolicyArns:
        - !Ref EbsLambdaEC2Policy
        - !Ref EbsLambdaLogPolicy
      RoleName: EbsLambdaServiceRole

EbsLambdaEC2Policy:
  Type: &quot;AWS::IAM::ManagedPolicy&quot;
  Properties:
    Description: &quot;Managed Policy to grant Lambda permissions to access EC2 for EBS tags&quot;
    Path: &quot;/&quot;
    PolicyDocument:
      Version: &quot;2012-10-17&quot;
      Statement:
        -
          Sid: &quot;AllowLambdaToAccessEC2&quot;
          Effect: &quot;Allow&quot;
          Action:
            - ec2:* #ec2:Describe* #TO-DO: check for permissions
          # Condition:
          #   &quot;StringEquals&quot;:
          #     - ec2:ResourceTag
          Resource: &quot;*&quot; #arn:aws:ec2:us-east-1:&quot;acc-no&quot;:instance/*
    ManagedPolicyName: EbsLambdaEC2Policy

EbsLambdaLogPolicy:
  Type: AWS::IAM::ManagedPolicy
  Properties:
    Description: &quot;Managed Policy to give access to Lambda to create logs in cloudwatch&quot;
    Path: &quot;/&quot;
    PolicyDocument:
      Version: &quot;2012-10-17&quot;
      Statement:
       -
         Sid: &quot;AllowLambdaToCreateLogs&quot;
         Effect: Allow
         Action:
           - logs:*
         Resource: &quot;*&quot;
    ManagedPolicyName: EbsLambdaLogPolicy
</code></pre>

<ul>
<li>We need to trigger the lambda function(L) from the Cloudwatch events(CE) in regular intervals using <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html" target="_blank">ScheduledRule</a> and give Cloudwatch Events permission to <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-permission.html" target="_blank">invoke Lambda</a>.</li>
</ul>

<pre><code class="language-yaml">ScheduledRule:
  Type: &quot;AWS::Events::Rule&quot;
  Properties:
    Description: &quot;AWS Rule to run the function in specific intervals&quot;
    ScheduleExpression: &quot;rate(60 minutes)&quot;
    State: &quot;ENABLED&quot;
    Targets:
      - Arn: !GetAtt lambdaEbsFunction.Arn
        Id: &quot;TargetFunctionV1&quot;

PermissionForEventsToInvokeLambda:
  Type: &quot;AWS::Lambda::Permission&quot;
  Properties:
    FunctionName: !GetAtt lambdaEbsFunction.Arn
    Action: &quot;lambda:InvokeFunction&quot;
    Principal: &quot;events.amazonaws.com&quot;
    SourceArn:
      Fn::GetAtt:
        - ScheduledRule
        - &quot;Arn&quot;
</code></pre>

<ul>
<li>Create a Lambda function that <a href="https://bapi24.github.io/post/aws-tags/" target="_blank">tags EBS volumes of the corresponding EC2 instances</a> (which we worked on our previous post) through a cloudformation script</li>
</ul>

<pre><code class="language-YAML">lambdaEbsFunction:
  Type: &quot;AWS::Lambda::Function&quot;
  Properties:
    Code:
      ZipFile: |
        #!/usr/bin/env python
        from __future__ import print_function
        import boto3
        import json
        import logging

        #setup simple logging for INFO.
        logger = logging.getLogger()
        logger.setLevel(logging.ERROR)

        #define the connection for EC2.
        ec2 = boto3.resource('ec2', region_name=&quot;us-east-2&quot;)
        def lambda_handler(event, context):
          def tag_them(instance, detail):
              tempTags=[]
              v={}

              for t in instance.tags:
                  #pull the name tag and add volume detail
                  if t['Key'] == 'Name':
                      v['Value'] = t['Value'] + &quot; - &quot; + str(detail)
                      v['Key'] = 'Name'
                      tempTags.append(v)
                  #append the wanted tags to EBS
                  elif t['Key'] == 'Owner':
                      print(&quot;[INFO]: Owner tag &quot; + str(t))
                      tempTags.append(t)
                  elif t['Key'] == 'Environment':
                      print(&quot;[INFO]: Environment Tag &quot; + str(t))
                      tempTags.append(t)
                  else:
                      print(&quot;[INFO]: Skip Tag - &quot; + str(t))

              print(&quot;[INFO] &quot; + str(tempTags))
              return(tempTags)

          base_instances = ec2.instances.filter(
              Filters = [

                          {
                              'Name': 'tag:Name',
                              'Values': ['Jenkins Server']
                          },

                      ]
          )

          for instance in base_instances:
              for vol in instance.volumes.all():
                  tag = vol.create_tags(Tags=tag_them(instance, vol.attachments[0]['Device']))
                  print(&quot;[INFO]: &quot; + str(tag))

    Description: &quot;Function to add tags to EBS&quot;
    FunctionName: !Ref lambdaFunctionName
    Handler: &quot;index.lambda_handler&quot;
    Role: &quot;arn:aws:iam::123456789:role/EbsLambdaServiceRole&quot; #TODO: account number hard-coded
    Runtime: &quot;python3.6&quot;
    Timeout: 5

</code></pre>

<p>You can get the complete CloudFormation scripts  <a href="https://github.com/bapi24/aws_labs/tree/master/serverless/ebstags/cfn" target="_blank">here</a>.</p>

    </div>
  </div>

</article>



<div class="article-container">
  <h3>Related</h3>
  <ul>
    
    <li><a href="/post/aws-tags/">Working with AWS tags</a></li>
    
    <li><a href="/post/sample-cfn-stack/">Deploy EC2 using Sample CloudFormation stack</a></li>
    
    <li><a href="/post/setup-aws-cli-on-mac/">Setting up AWS cli on mac</a></li>
    
  </ul>
</div>


<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="https://bapi24.github.io/post/aws-tags/"><span
      aria-hidden="true">&larr;</span> Working with AWS tags</a></li>
    

    
  </ul>
</nav>

</div>

<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "bapi24-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Bapi Loya &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

